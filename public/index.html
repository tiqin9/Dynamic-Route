<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Milk Run Route Planner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .stop-input-group {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .stop-input-group input {
      margin-bottom: 10px;
    }

    .remove-btn {
      background: #ff6b6b;
      padding: 8px 16px;
      font-size: 0.9em;
      width: 100%;
    }

    .remove-btn:hover {
      background: #ff5252;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .add-stop-btn {
      width: 100%;
      margin-bottom: 15px;
    }

    .metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .metric {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }

    .metric-label {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .metric-value {
      color: #333;
      font-size: 1.5em;
      font-weight: bold;
    }

    .routes-section {
      grid-column: 1 / -1;
    }

    .route-item {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .route-name {
      color: #333;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .route-details {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .route-detail {
      background: white;
      padding: 10px;
      border-radius: 3px;
    }

    .route-detail-label {
      color: #666;
      font-size: 0.85em;
    }

    .route-detail-value {
      color: #333;
      font-weight: bold;
    }

    .route-stops {
      background: white;
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 10px;
      max-height: 150px;
      overflow-y: auto;
    }

    .stop {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9em;
      color: #333;
    }

    .stop:last-child {
      border-bottom: none;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .action-buttons button {
      flex: 1;
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .optimize-btn {
      background: #51cf66;
    }

    .optimize-btn:hover {
      box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
    }

    .delete-btn {
      background: #ff6b6b;
    }

    .delete-btn:hover {
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .loading {
      text-align: center;
      color: #666;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .route-details {
        grid-template-columns: 1fr 1fr;
      }
    }

    #mapContainer {
      width: 100%;
      height: 500px;
      border-radius: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
    }

    .map-controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
    }

    .map-legend {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      font-size: 0.9em;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #333;
    }

    .legend-color.start {
      background: #51cf66;
    }

    .legend-color.end {
      background: #ff6b6b;
    }

    .legend-color.stop {
      background: #667eea;
    }

    .map-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .map-stat {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      border-left: 3px solid #667eea;
    }

    .map-stat-label {
      color: #666;
      font-size: 0.85em;
    }

    .map-stat-value {
      color: #333;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸšš Milk Run Route Planner</h1>
      <p>Optimize your delivery routes efficiently</p>
      <p style="margin-top: 15px;"><a href="/planner.html" style="color: white; text-decoration: underline; font-weight: bold;">â†’ Launch Full Dynamic Planner with Advanced Constraints</a></p>
    </div>

    <div class="content">
      <!-- Route Creation Form -->
      <div class="card">
        <h2>Create New Route</h2>
        <div id="message"></div>

        <div class="form-group">
          <label for="routeName">Route Name</label>
          <input type="text" id="routeName" placeholder="e.g., Downtown Route A">
        </div>

        <div id="stopsContainer"></div>

        <button class="add-stop-btn" onclick="addStop()">+ Add Stop</button>
        <button onclick="createRoute()" style="width: 100%;">Create & Optimize Route</button>
      </div>

      <!-- Route Information -->
      <div class="card">
        <h2>Route Preview</h2>
        <p style="color: #666; margin-bottom: 15px;">Create a route to see map preview here.</p>
        <div id="routeInfo"></div>
        <div id="mapContainer"></div>
        <div class="map-legend">
          <strong>Map Legend</strong>
          <div class="legend-item">
            <div class="legend-color start"></div>
            <span>Start Point</span>
          </div>
          <div class="legend-item">
            <div class="legend-color stop"></div>
            <span>Delivery Stop</span>
          </div>
          <div class="legend-item">
            <div class="legend-color end"></div>
            <span>End Point</span>
          </div>
        </div>
        <div class="map-stats">
          <div class="map-stat">
            <div class="map-stat-label">Route Distance</div>
            <div class="map-stat-value" id="mapDistance">-</div>
          </div>
          <div class="map-stat">
            <div class="map-stat-label">Estimated Time</div>
            <div class="map-stat-value" id="mapTime">-</div>
          </div>
        </div>
      </div>

      <!-- Routes List -->
      <div class="card routes-section">
        <h2>Saved Routes</h2>
        <div id="routesList"></div>
      </div>
    </div>
  </div>

  <script>
    // Mock data for GitHub Pages (no backend needed)
    let routes = [];
    let currentMap = null;
    let currentRoute = null;
    const STORAGE_KEY = 'milkRunRoutes';

    // Load routes from localStorage on page init
    function initializeApp() {
      loadRoutesFromStorage();
      if (routes.length === 0) {
        loadMockData();
      }
      addStop();
      loadRoutes();
    }

    // Mock sample routes
    function loadMockData() {
      const mockRoutes = [
        {
          id: 'route-1',
          name: 'Downtown Delivery',
          stops: [
            { name: 'Distribution Center', latitude: 40.7128, longitude: -74.0060, deliveryTime: 0, quantity: 50 },
            { name: 'Store 1 - Park Ave', latitude: 40.7580, longitude: -73.9855, deliveryTime: 10, quantity: 15 },
            { name: 'Store 2 - 5th Ave', latitude: 40.7489, longitude: -73.9680, deliveryTime: 8, quantity: 12 },
            { name: 'Store 3 - Madison Ave', latitude: 40.7505, longitude: -73.9728, deliveryTime: 10, quantity: 10 },
            { name: 'Store 4 - Broadway', latitude: 40.7614, longitude: -73.9776, deliveryTime: 8, quantity: 8 }
          ],
          totalDistance: 8.5,
          totalTime: 156,
          createdAt: new Date().toISOString()
        },
        {
          id: 'route-2',
          name: 'Brooklyn West Route',
          stops: [
            { name: 'Hub', latitude: 40.6501, longitude: -74.0096, deliveryTime: 0, quantity: 40 },
            { name: 'Williamsburg Store', latitude: 40.7081, longitude: -73.9581, deliveryTime: 12, quantity: 10 },
            { name: 'Greenpoint Location', latitude: 40.7282, longitude: -73.9442, deliveryTime: 10, quantity: 8 },
            { name: 'Astoria Pickup', latitude: 40.7614, longitude: -73.9282, deliveryTime: 15, quantity: 12 }
          ],
          totalDistance: 12.3,
          totalTime: 198,
          createdAt: new Date().toISOString()
        }
      ];
      routes = mockRoutes;
      saveRoutesToStorage();
    }

    function saveRoutesToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
    }

    function loadRoutesFromStorage() {
      const stored = localStorage.getItem(STORAGE_KEY);
      routes = stored ? JSON.parse(stored) : [];
    }

    function generateRouteId() {
      return 'route-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Calculate distance between two coordinates (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Optimize route using nearest neighbor algorithm
    function optimizeRoute(stops) {
      if (stops.length < 2) return stops;
      
      const optimized = [stops[0]]; // Start with first stop
      const remaining = stops.slice(1);
      
      while (remaining.length > 0) {
        const last = optimized[optimized.length - 1];
        let nearest = remaining[0];
        let minDist = calculateDistance(last.latitude, last.longitude, nearest.latitude, nearest.longitude);
        let nearestIdx = 0;
        
        for (let i = 1; i < remaining.length; i++) {
          const dist = calculateDistance(last.latitude, last.longitude, remaining[i].latitude, remaining[i].longitude);
          if (dist < minDist) {
            minDist = dist;
            nearest = remaining[i];
            nearestIdx = i;
          }
        }
        
        optimized.push(nearest);
        remaining.splice(nearestIdx, 1);
      }
      
      return optimized;
    }

    // Calculate route metrics
    function calculateMetrics(stops) {
      let totalDistance = 0;
      let totalTime = 0;
      
      for (let i = 0; i < stops.length - 1; i++) {
        totalDistance += calculateDistance(
          stops[i].latitude, stops[i].longitude,
          stops[i+1].latitude, stops[i+1].longitude
        );
      }
      
      stops.forEach(stop => {
        totalTime += stop.deliveryTime || 5;
      });
      
      // Add travel time (assume 1 minute per km)
      totalTime += totalDistance;
      
      return {
        totalDistance,
        totalTime,
        stopCount: stops.length,
        averageStopDistance: totalDistance / (stops.length - 1)
      };
    }

    // Initialize with one empty stop
    initializeApp();

    function addStop() {
      const container = document.getElementById('stopsContainer');
      const stopIndex = container.children.length;
      
      const stopDiv = document.createElement('div');
      stopDiv.className = 'stop-input-group';
      stopDiv.innerHTML = `
        <div class="form-group">
          <label>Stop ${stopIndex + 1} Name</label>
          <input type="text" class="stop-name" placeholder="e.g., Store 1">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="form-group">
            <label>Latitude</label>
            <input type="number" class="stop-lat" placeholder="e.g., 40.7128" step="0.0001">
          </div>
          <div class="form-group">
            <label>Longitude</label>
            <input type="number" class="stop-lon" placeholder="e.g., -74.0060" step="0.0001">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="form-group">
            <label>Delivery Time (minutes)</label>
            <input type="number" class="stop-time" placeholder="5" value="5" min="1">
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" class="stop-qty" placeholder="Units" min="1">
          </div>
        </div>
        ${stopIndex > 0 ? `<button class="remove-btn" onclick="removeStop(this)">Remove Stop</button>` : ''}
      `;
      
      container.appendChild(stopDiv);
    }

    function removeStop(btn) {
      btn.parentElement.remove();
      updateStopLabels();
    }

    function updateStopLabels() {
      const stops = document.querySelectorAll('.stop-input-group');
      stops.forEach((stop, index) => {
        const label = stop.querySelector('label');
        if (label) label.textContent = `Stop ${index + 1} Name`;
      });
    }

    async function createRoute() {
      const routeName = document.getElementById('routeName').value.trim();
      const messageDiv = document.getElementById('message');

      if (!routeName) {
        showMessage('Please enter a route name', 'error', messageDiv);
        return;
      }

      const stops = [];
      document.querySelectorAll('.stop-input-group').forEach(stopDiv => {
        const name = stopDiv.querySelector('.stop-name').value.trim();
        const lat = parseFloat(stopDiv.querySelector('.stop-lat').value);
        const lon = parseFloat(stopDiv.querySelector('.stop-lon').value);
        const deliveryTime = parseInt(stopDiv.querySelector('.stop-time').value) || 5;
        const quantity = parseInt(stopDiv.querySelector('.stop-qty').value) || 1;

        if (name && !isNaN(lat) && !isNaN(lon)) {
          stops.push({ name, latitude: lat, longitude: lon, deliveryTime, quantity });
        }
      });

      if (stops.length < 2) {
        showMessage('Please add at least 2 stops with valid coordinates', 'error', messageDiv);
        return;
      }

      try {
        messageDiv.innerHTML = '<div class="loading">ðŸ”„ Optimizing route...</div>';
        
        // Simulate processing delay
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Optimize the route locally
        const optimizedStops = optimizeRoute(stops);
        const metrics = calculateMetrics(optimizedStops);
        
        // Create route object
        const route = {
          id: generateRouteId(),
          name: routeName,
          stops: optimizedStops,
          totalDistance: metrics.totalDistance,
          totalTime: metrics.totalTime,
          createdAt: new Date().toISOString()
        };
        
        // Save to storage
        routes.push(route);
        saveRoutesToStorage();
        
        showMessage('Route created and optimized successfully! âœ“', 'success', messageDiv);
        
        displayRoute(route, metrics);
        loadRoutes();
        
        // Reset form
        document.getElementById('routeName').value = '';
        document.getElementById('stopsContainer').innerHTML = '';
        addStop();
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error', messageDiv);
      }
    }

    function displayRoute(route, metrics) {
      const routeInfo = document.getElementById('routeInfo');
      const stopsHtml = route.stops.map((stop, i) => 
        `${i + 1}. ${stop.name} (${stop.latitude.toFixed(4)}, ${stop.longitude.toFixed(4)})`
      ).join('<br>');

      routeInfo.innerHTML = `
        <div class="metric-label">Route Name</div>
        <div class="metric-value" style="margin-bottom: 15px;">${route.name}</div>
        
        <div class="route-stops"><strong>Optimized Sequence:</strong><br>${stopsHtml}</div>
        
        <div class="metrics">
          <div class="metric">
            <div class="metric-label">Total Distance</div>
            <div class="metric-value">${metrics.totalDistance.toFixed(2)} km</div>
          </div>
          <div class="metric">
            <div class="metric-label">Total Time</div>
            <div class="metric-value">${Math.round(metrics.totalTime)} min</div>
          </div>
          <div class="metric">
            <div class="metric-label">Stops</div>
            <div class="metric-value">${metrics.stopCount}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Avg Distance</div>
            <div class="metric-value">${metrics.averageStopDistance.toFixed(2)} km</div>
          </div>
        </div>
      `;

      // Update map stats
      document.getElementById('mapDistance').textContent = metrics.totalDistance.toFixed(2) + ' km';
      document.getElementById('mapTime').textContent = Math.round(metrics.totalTime) + ' min';

      // Render map
      currentRoute = route;
      renderRouteMap(route);
    }

    async function loadRoutes() {
      try {
        const routesList = document.getElementById('routesList');
        if (routes.length === 0) {
          routesList.innerHTML = '<p style="color: #666;">No routes created yet.</p>';
          return;
        }

        routesList.innerHTML = routes.map(route => {
          const distance = route.totalDistance.toFixed(2);
          const time = Math.round(route.totalTime);
          const created = new Date(route.createdAt).toLocaleDateString();
          
          return `
            <div class="route-item">
              <div class="route-name">${route.name}</div>
              <div class="route-details">
                <div class="route-detail">
                  <div class="route-detail-label">Distance</div>
                  <div class="route-detail-value">${distance} km</div>
                </div>
                <div class="route-detail">
                  <div class="route-detail-label">Time</div>
                  <div class="route-detail-value">${time} min</div>
                </div>
                <div class="route-detail">
                  <div class="route-detail-label">Stops</div>
                  <div class="route-detail-value">${route.stops.length}</div>
                </div>
                <div class="route-detail">
                  <div class="route-detail-label">Created</div>
                  <div class="route-detail-value">${created}</div>
                </div>
              </div>
              <div class="route-stops">
                ${route.stops.map((s, i) => `${i + 1}. ${s.name}`).join('<br>')}
              </div>
              <div class="action-buttons">
                <button class="optimize-btn" onclick="viewRoutePreview('${route.id}')">View Preview</button>
                <button class="optimize-btn" onclick="reOptimizeRoute('${route.id}')">Re-optimize</button>
                <button class="delete-btn" onclick="deleteRoute('${route.id}')">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading routes:', error);
      }
    }

    async function reOptimizeRoute(routeId) {
      try {
        const route = routes.find(r => r.id === routeId);
        if (!route) throw new Error('Route not found');
        
        // Re-optimize the stops
        const optimizedStops = optimizeRoute(route.stops);
        const metrics = calculateMetrics(optimizedStops);
        
        route.stops = optimizedStops;
        route.totalDistance = metrics.totalDistance;
        route.totalTime = metrics.totalTime;
        
        saveRoutesToStorage();
        
        showMessage('Route re-optimized successfully! âœ“', 'success', document.getElementById('message'));
        displayRoute(route, metrics);
        loadRoutes();
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error', document.getElementById('message'));
      }
    }

    async function viewRoutePreview(routeId) {
      try {
        const route = routes.find(r => r.id === routeId);
        if (!route) throw new Error('Route not found');

        const metrics = calculateMetrics(route.stops);
        displayRoute(route, metrics);
        
        // Scroll to preview section
        document.querySelector('.routes-section').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error', document.getElementById('message'));
      }
    }

    async function deleteRoute(routeId) {
      if (!confirm('Are you sure you want to delete this route?')) return;

      try {
        const idx = routes.findIndex(r => r.id === routeId);
        if (idx === -1) throw new Error('Route not found');
        
        routes.splice(idx, 1);
        saveRoutesToStorage();

        showMessage('Route deleted successfully! âœ“', 'success', document.getElementById('message'));
        loadRoutes();
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error', document.getElementById('message'));
      }
    }

    function showMessage(text, type, element) {
      element.className = `message ${type}`;
      element.textContent = text;
      setTimeout(() => {
        element.className = 'message';
      }, 5000);
    }

    function renderRouteMap(route) {
      if (!route || !route.stops || route.stops.length === 0) return;

      const mapContainer = document.getElementById('mapContainer');
      
      // Remove old map if exists
      if (currentMap) {
        currentMap.remove();
      }

      // Initialize map centered on first stop
      currentMap = L.map(mapContainer).setView(
        [route.stops[0].latitude, route.stops[0].longitude],
        13
      );

      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(currentMap);

      // Add markers for each stop
      route.stops.forEach((stop, index) => {
        const isStart = index === 0;
        const isEnd = index === route.stops.length - 1;
        const markerColor = isStart ? '#51cf66' : isEnd ? '#ff6b6b' : '#667eea';
        
        // Create custom marker
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: `
            <div style="
              background: ${markerColor};
              color: white;
              border-radius: 50%;
              width: 35px;
              height: 35px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
              border: 3px solid white;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">
              ${index + 1}
            </div>
          `,
          iconSize: [35, 35],
          iconAnchor: [17, 17],
          popupAnchor: [0, -17]
        });

        const marker = L.marker([stop.latitude, stop.longitude], { icon: markerIcon })
          .addTo(currentMap);

        // Add popup
        marker.bindPopup(`
          <strong>${stop.name}</strong><br>
          Stop ${index + 1} of ${route.stops.length}<br>
          <small>${stop.latitude.toFixed(4)}, ${stop.longitude.toFixed(4)}</small><br>
          <small>Delivery: ${stop.deliveryTime || 5} min</small>
        `, { maxWidth: 200 });
      });

      // Draw route line
      const latlngs = route.stops.map(stop => [stop.latitude, stop.longitude]);
      const polyline = L.polyline(latlngs, {
        color: '#667eea',
        weight: 3,
        opacity: 0.8,
        dashArray: '5, 5'
      }).addTo(currentMap);

      // Fit map bounds to route
      const group = new L.featureGroup(latlngs.map(ll => L.marker(ll)));
      currentMap.fitBounds(group.getBounds().pad(0.1));

      // Add distance popup for each segment
      for (let i = 0; i < route.stops.length - 1; i++) {
        const stop1 = route.stops[i];
        const stop2 = route.stops[i + 1];
        const midLat = (stop1.latitude + stop2.latitude) / 2;
        const midLon = (stop1.longitude + stop2.longitude) / 2;
        
        const distance = L.latLng(stop1.latitude, stop1.longitude)
          .distanceTo(L.latLng(stop2.latitude, stop2.longitude)) / 1000;
        
        L.popup({ className: 'route-segment-popup' })
          .setLatLng([midLat, midLon])
          .setContent(`${distance.toFixed(2)} km`)
          .addTo(currentMap);
      }
    }

    // Load routes on page load
    loadRoutes();
    setInterval(loadRoutes, 5000);
  </script>
</body>
</html>
